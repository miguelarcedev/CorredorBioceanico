{% extends 'transporte/base.html' %}
{% block content %}
<div class="container-fluid mt-4">
  <h2>Simulación de viajes - Modo Demo</h2>

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Viajes disponibles para simular</h5>
    </div>
    <div class="card-body p-0">
      <table class="table table-striped table-hover mb-0 text-center align-middle">
        <thead class="table-light">
          <tr>
            <th>Origen</th>
            <th>Destino</th>
            <th>Estado</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody>
          {% for viaje in viajes %}
          <tr>
            <td>{{ viaje.origen }}</td>
            <td>{{ viaje.destino }}</td>
            <td><span class="badge bg-info text-dark">{{ viaje.estado }}</span></td>
            <td>
              <button class="btn btn-primary btn-sm btn-simular"
                      data-origen="{{ viaje.origen }}"
                      data-destino="{{ viaje.destino }}"
                      data-lat1="{{ viaje.posiciones.first.latitud }}"
                      data-lon1="{{ viaje.posiciones.first.longitud }}"
                      data-lat2="{{ viaje.posiciones.last.latitud }}"
                      data-lon2="{{ viaje.posiciones.last.longitud }}">
                Simular
              </button>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="4" class="text-center text-muted py-3">No hay viajes disponibles</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-success text-white">Mapa del recorrido</div>
    <div class="card-body p-0">
      <div id="map" style="height: 550px; border-radius: 10px;"></div>
    </div>
  </div>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
const API_KEY = "TU_API_KEY_AQUI";  // ⚠️ Coloca aquí tu API Key de OpenRouteService

let map = L.map('map').setView([-24.1858, -65.2995], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

let polyline = null;
let marker = null;
let animInterval = null;

// ============================
//   OBTENER RUTA REAL
// ============================
async function obtenerRutaReal(origen, destino) {
  const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${API_KEY}&start=${origen[1]},${origen[0]}&end=${destino[1]},${destino[0]}`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error("Error obteniendo ruta");
  const data = await resp.json();
  const coords = data.features[0].geometry.coordinates.map(([lon, lat]) => [lat, lon]);
  return coords;
}

// ============================
//   ANIMAR VEHÍCULO
// ============================
function moverMarcadorSuave(marker, start, end, duracion = 3000) {
  const steps = 30;
  let i = 0;
  const interval = setInterval(() => {
    const lat = start[0] + (end[0] - start[0]) * (i / steps);
    const lon = start[1] + (end[1] - start[1]) * (i / steps);
    marker.setLatLng([lat, lon]);
    if (i++ >= steps) clearInterval(interval);
  }, duracion / steps);
}

// ============================
//   SIMULAR VIAJE
// ============================
async function iniciarSimulacion(origen, destino) {
  if (animInterval) clearInterval(animInterval);
  if (polyline) map.removeLayer(polyline);
  if (marker) map.removeLayer(marker);

  try {
    const ruta = await obtenerRutaReal(origen, destino);
    polyline = L.polyline(ruta, { color: 'blue' }).addTo(map);
    map.fitBounds(polyline.getBounds());
    marker = L.marker(ruta[0]).addTo(map);

    let index = 0;
    animInterval = setInterval(() => {
      if (index < ruta.length - 1) {
        moverMarcadorSuave(marker, ruta[index], ruta[index + 1]);
        index++;
      } else {
        clearInterval(animInterval);
      }
    }, 3000);
  } catch (err) {
    console.error("Error en la simulación:", err);
    alert("No se pudo obtener la ruta real. Verifique su API Key o conexión.");
  }
}

// ============================
//   EVENTO DE BOTONES
// ============================
document.querySelectorAll(".btn-simular").forEach(btn => {
  btn.addEventListener("click", async () => {
    const lat1 = parseFloat(btn.dataset.lat1);
    const lon1 = parseFloat(btn.dataset.lon1);
    const lat2 = parseFloat(btn.dataset.lat2);
    const lon2 = parseFloat(btn.dataset.lon2);

    if (isNaN(lat1) || isNaN(lat2)) {
      alert("Este viaje no tiene posiciones válidas para simular.");
      return;
    }

    await iniciarSimulacion([lat1, lon1], [lat2, lon2]);
  });
});
</script>
{% endblock %}
