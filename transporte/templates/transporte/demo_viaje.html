{% extends 'transporte/base.html' %}
{% block content %}

<style>
    /* --- ESTILO GENERAL --- */
    .card {
        border: none;
        border-radius: 12px;
    }
    .card-header {
        font-weight: 600;
        letter-spacing: 0.3px;
    }
    .table thead th {
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        border-bottom: 2px solid #e9ecef !important;
    }
    .table tbody td {
        font-size: 0.9rem;
        padding: 0.75rem;
    }
    .btn-simular {
        padding: 4px 10px;
        font-size: 0.8rem;
        border-radius: 6px;
    }

    /* --- COLORES MINIMALISTAS --- */
    .bg-primary {
        background: #1e88e5 !important;
    }
    .bg-success {
        background: #43a047 !important;
    }
    .badge {
        padding: 6px 10px;
        font-size: 0.75rem;
        border-radius: 6px;
    }

    /* --- MAPA --- */
    #map {
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

</style>

<div class="container-fluid mt-4">

  <!-- VIAJES EN CURSO -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white d-flex align-items-center">
      <h5 class="mb-0">Viajes en curso</h5>
    </div>

    <div class="card-body p-0">
      <table class="table table-hover mb-0 text-center align-middle">
        <thead class="table-light">
          <tr>
            <th>Origen</th>
            <th>Destino</th>
            <th>Estado</th>
            <th class="text-center">Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="tabla-viajes">

          {% for viaje in viajes %}
          <tr id="fila-{{ viaje.id }}">
              <td>{{ viaje.origen }}</td>
              <td>{{ viaje.destino }}</td>
              <td>
                <span class="badge bg-info text-dark">
                    {{ viaje.estado }}
                </span>
              </td>
              <td>
                <button class="btn btn-primary btn-simular"
                    data-id="{{ viaje.id }}"
                    data-lat1="{{ viaje.lat_origen|floatformat:6 }}"
                    data-lon1="{{ viaje.lon_origen|floatformat:6 }}"
                    data-lat2="{{ viaje.lat_destino|floatformat:6 }}"
                    data-lon2="{{ viaje.lon_destino|floatformat:6 }}">
                    Monitorear
                </button>
              </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="text-muted py-3">No hay viajes</td>
          </tr>
          {% endfor %}

        </tbody>
      </table>
    </div>
  </div>

  <!-- MAPA -->
  <div class="card shadow-sm">
    <div class="card-header bg-success text-white">
      Mapa del recorrido
    </div>
    <div class="card-body p-0">
      <div id="map" style="height: 500px;"></div>
    </div>
  </div>

</div>

<script>
/* =======================================================
   Inicializar mapa
======================================================= */
document.addEventListener("DOMContentLoaded", () => {

    console.log("Mapa cargando...");

    window.map = L.map('map').setView([-24.1858, -65.2995], 10);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    window.polyline = null;
    window.marker = null;
    window.animInterval = null;

    document.querySelectorAll(".btn-simular").forEach(btn => {
        btn.addEventListener("click", () => {

            const viaje_id = btn.dataset.id;

            // üî• FIX IMPORTANTE: reemplazar comas
            const lat1 = parseFloat(btn.dataset.lat1.replace(",", "."));
            const lon1 = parseFloat(btn.dataset.lon1.replace(",", "."));
            const lat2 = parseFloat(btn.dataset.lat2.replace(",", "."));
            const lon2 = parseFloat(btn.dataset.lon2.replace(",", "."));

            iniciarSimulacion(viaje_id, lat1, lon1, lat2, lon2);
        });
    });
});

/* =======================================================
   Convertir ruta a Leaflet
======================================================= */
function fixRuta(arr) {
    return arr.map(p => L.latLng(p[0], p[1]));
}

/* =======================================================
   Obtener ruta desde el backend
======================================================= */
async function obtenerRuta(start, end) {
    try {
        const response = await fetch(`/api/ruta/?start=${start}&end=${end}`);
        return await response.json();
    } catch (err) {
        console.error(err);
        return null;
    }
}

/* =======================================================
   Guardar posici√≥n
======================================================= */
async function guardarPosicion(viaje_id, lat, lon, velocidad) {

    await fetch("/api/guardar_posicion/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            viaje_id: viaje_id,
            latitud: lat,
            longitud: lon,
            velocidad: velocidad
        })
    });
}

/* =======================================================
   Finalizar viaje
======================================================= */
async function finalizarViaje(viaje_id) {

    const resp = await fetch("/api/finalizar_viaje/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ viaje_id })
    });

    const data = await resp.json();

    if (data.ok) {
        const fila = document.getElementById(`fila-${viaje_id}`);
        if (fila) fila.remove();
    }
}

/* =======================================================
   Simulaci√≥n principal
======================================================= */
async function iniciarSimulacion(viaje_id, lat1, lon1, lat2, lon2) {

    if (animInterval) clearInterval(animInterval);
    if (polyline) map.removeLayer(polyline);
    if (marker) map.removeLayer(marker);

    const ruta = await obtenerRuta(`${lat1},${lon1}`, `${lat2},${lon2}`);

    if (!ruta || !Array.isArray(ruta) || ruta.length < 2) {
        alert("No se pudo obtener la ruta.");
        return;
    }

    const rutaFix = fixRuta(ruta);

    polyline = L.polyline(rutaFix, { color: 'blue' }).addTo(map);
    map.fitBounds(polyline.getBounds());

    marker = L.marker(rutaFix[0]).addTo(map);
    map.panTo(rutaFix[0]);

    let index = 0;
    const delay = 1000;

    animInterval = setInterval(async () => {

        if (index >= rutaFix.length) {
            clearInterval(animInterval);

            await finalizarViaje(viaje_id);

            alert("Viaje finalizado.");
            return;
        }

        const actual = rutaFix[index];
        const anterior = rutaFix[index - 1] || actual;

        // velocidad aproximada
        const distancia = map.distance(anterior, actual);

        const velocidad = ((distancia / (delay / 1000)) * 3.6) / 10;
        //const velocidad = 50 + Math.random() * 40;

        marker.setLatLng(actual);
        map.panTo(actual);

        await guardarPosicion(viaje_id, actual.lat, actual.lng, velocidad);

        index++;

    }, delay);
}

</script>

{% endblock %}
