{% extends "transporte/base.html" %}
{% load static %}

{% block content %}

<h3 class="mb-4"><i class="bi bi-broadcast-pin"></i> Monitoreo de Viaje</h3>

<div class="row">
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Viajes en curso</h5>

                {% if viajes %}
                <ul class="list-group">
                    {% for viaje in viajes %}
                    <li class="list-group-item seleccionar-viaje"
                        style="cursor:pointer"
                        data-inicio="{{ viaje.lat_origen }},{{ viaje.lon_origen }}"
                        data-destino="{{ viaje.lat_destino }},{{ viaje.lon_destino }}">
                        <strong>{{ viaje.descripcion }}</strong><br>
                        <small>{{ viaje.origen }} → {{ viaje.destino }}</small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No hay viajes en curso.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-8">

        <div id="map" style="height:520px;" class="shadow-sm mb-3"></div>

        <button id="btnPlay" class="btn btn-primary w-100">
            <i class="bi bi-play-circle"></i> Iniciar simulación
        </button>

    </div>
</div>

<script>
/* ============================
   VARIABLES GLOBALES
============================ */
let map, polyline, marker, ruta = [];

/* ============================
   INICIALIZAR MAPA
============================ */
document.addEventListener("DOMContentLoaded", function () {

    console.log("DOM cargado — creando mapa");

    map = L.map("map").setView([-24.185268, -65.298483], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
    }).addTo(map);

    // FIX Bootstrap + Leaflet: asegurar tamaño real
    setTimeout(() => map.invalidateSize(true), 300);
});

/* ============================
   CLICK EN UN VIAJE
============================ */
document.addEventListener("click", function (e) {
    if (!e.target.classList.contains("seleccionar-viaje")) return;

    const [latI, lonI] = e.target.dataset.inicio.split(",");
    const [latF, lonF] = e.target.dataset.destino.split(",");

    console.log("=== DEBUG COORDENADAS ===");
    console.log("Inicio:", latI, lonI);
    console.log("Destino:", latF, lonF);

    obtenerRuta(latI, lonI, latF, lonF);
});

/* ============================
   OBTENER RUTA DESDE EL SERVIDOR
============================ */
function obtenerRuta(latI, lonI, latF, lonF) {

    console.log(">>> Llamando a API ruta:");
    console.log("Start:", `${latI},${lonI}`);
    console.log("End:", `${latF},${lonF}`);

    fetch(`/api/ruta/?start=${latI},${lonI}&end=${latF},${lonF}`)
        .then(r => r.json())
        .then(data => {

            console.log("=== DEBUG RUTA OBTENIDA ===");
            console.log(data);

            if (!Array.isArray(data.ruta)) {
                alert("Error en la ruta recibida");
                return;
            }

            ruta = data.ruta.map(p => [p.lat, p.lon]);

            console.log("=== DEBUG RUTA TRANSFORMADA PARA LEAFLET ===");
            console.log(ruta);

            dibujarRuta();
        })
        .catch(err => console.error(err));
}

/* ============================
   DIBUJAR LA RUTA
============================ */
function dibujarRuta() {

    setTimeout(() => {
        map.invalidateSize(true);

        if (polyline) map.removeLayer(polyline);
        if (marker) map.removeLayer(marker);

        polyline = L.polyline(ruta, { color: "blue" }).addTo(map);

        marker = L.marker(ruta[0]).addTo(map);

        const bounds = polyline.getBounds();
        map.fitBounds(bounds, { padding: [30, 30] });

    }, 150); // delay crucial para evitar Bounds.js error
}

/* ============================
   SIMULACIÓN
============================ */
document.getElementById("btnPlay").addEventListener("click", function () {
    if (!ruta.length) {
        alert("Selecciona un viaje primero.");
        return;
    }

    let index = 0;

    const interval = setInterval(() => {
        if (index >= ruta.length) {
            clearInterval(interval);
            return;
        }

        const punto = ruta[index];

        marker.setLatLng(punto);
        map.panTo(punto, { animate: true, duration: 0.25 });

        index++;

    }, 300);
});
</script>

{% endblock %}
