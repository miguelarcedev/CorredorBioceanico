{% extends 'transporte/base.html' %}
{% block content %}

<div class="container-fluid mt-4">

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Viajes en curso</h5>
    </div>
    <div class="card-body p-0">
      <table class="table table-striped table-hover mb-0 text-center align-middle">
        <thead class="table-light">
          <tr>
            <th>Origen</th>
            <th>Destino</th>
            <th>Estado</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="tabla-viajes">

          {% for viaje in viajes %}
          <tr>
              <td>{{ viaje.origen }}</td>
              <td>{{ viaje.destino }}</td>
              <td><span class="badge bg-info text-dark">{{ viaje.estado }}</span></td>
              <td>
                  <button class="btn btn-primary btn-sm btn-simular"
                          data-lat1="{{ viaje.lat_origen|floatformat:'6' }}"
                          data-lon1="{{ viaje.lon_origen|floatformat:'6' }}"
                          data-lat2="{{ viaje.lat_destino|floatformat:'6' }}"
                          data-lon2="{{ viaje.lon_destino|floatformat:'6' }}"></button>

                      Simular
                  </button>
              </td>
          </tr>
          {% empty %}
          <tr><td colspan="4" class="text-center text-muted py-3">No hay viajes</td></tr>
          {% endfor %}

        </tbody>
      </table>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-success text-white">Mapa del recorrido</div>
    <div class="card-body p-0">
      <div id="map" style="height: 550px; border-radius: 10px;"></div>
    </div>
  </div>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

function fixRuta(ruta) {
  return ruta.map(p => L.latLng(p[0], p[1]));
}

let map = L.map('map').setView([-24.1858, -65.2995], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

let polyline = null;
let marker = null;
let animInterval = null;

// ============================
//   OBTENER RUTA REAL
// ============================
async function obtenerRuta(start, end) {
  try {
    const response = await fetch(`/api/ruta/?start=${start}&end=${end}`);
    const data = await response.json();

    if (data.error) {
      console.error("Error obteniendo ruta:", data.error);
      return null;
    }

    return data;
  } catch (err) {
    console.error("Error de conexión al obtener ruta:", err);
    return null;
  }
}

// ============================
//     SIMULAR VIAJE
// ============================
async function iniciarSimulacion(lat1, lon1, lat2, lon2) {

  // ============================
  // DEBUG - VER COORDENADAS
  // ============================
  console.log("=== DEBUG COORDENADAS ===");
  console.log("Inicio:", lat1, lon1);
  console.log("Destino:", lat2, lon2);

  if (isNaN(lat1) || isNaN(lon1) || isNaN(lat2) || isNaN(lon2)) {
    console.error("Coordenadas inválidas:", lat1, lon1, lat2, lon2);
    alert("Coordenadas inválidas.");
    return;
  }

  if (animInterval) clearInterval(animInterval);
  if (polyline) map.removeLayer(polyline);
  if (marker) map.removeLayer(marker);

  const ruta = await obtenerRuta(`${lat1},${lon1}`, `${lat2},${lon2}`);

  console.log("=== DEBUG RUTA OBTENIDA ===");
  console.log(ruta);

  if (!ruta || ruta.length === 0) {
    console.error("La API devolvió una ruta vacía");
    alert("No se pudo obtener la ruta real.");
    return;
  }

  const rutaFix = fixRuta(ruta);

  console.log("=== DEBUG RUTA TRANSFORMADA PARA LEAFLET ===");
  console.log(rutaFix);

  polyline = L.polyline(rutaFix, { color: 'blue' }).addTo(map);
  map.fitBounds(polyline.getBounds());

  marker = L.marker(rutaFix[0]).addTo(map);
  map.panTo(rutaFix[0]);

  let index = 0;
  const delay = 300;

  animInterval = setInterval(() => {
    if (index >= rutaFix.length) {
      clearInterval(animInterval);
      return;
    }

    marker.setLatLng(rutaFix[index]);
    map.panTo(rutaFix[index]);

    index++;
  }, delay);
}

// ============================
//       INICIO
// ============================
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".btn-simular").forEach(btn => {
    btn.addEventListener("click", () => {
      const lat1 = parseFloat(btn.dataset.lat1);
      const lon1 = parseFloat(btn.dataset.lon1);
      const lat2 = parseFloat(btn.dataset.lat2);
      const lon2 = parseFloat(btn.dataset.lon2);

      iniciarSimulacion(lat1, lon1, lat2, lon2);
    });
  });
});

</script>

{% endblock %}
