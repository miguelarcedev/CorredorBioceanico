{% extends 'transporte/base.html' %}
{% block content %}

<div class="container-fluid mt-4">

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Viajes en curso</h5>
    </div>
    <div class="card-body p-0">
      <table class="table table-striped table-hover mb-0 text-center align-middle">
        <thead class="table-light">
          <tr>
            <th>Origen</th>
            <th>Destino</th>
            <th>Estado</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="tabla-viajes">

          {% for viaje in viajes %}
          <tr id="fila-{{ viaje.id }}">
              <td>{{ viaje.origen }}</td>
              <td>{{ viaje.destino }}</td>
              <td><span class="badge bg-info text-dark">{{ viaje.estado }}</span></td>
              <td>
                  <button class="btn btn-primary btn-sm btn-simular"
                      data-id="{{ viaje.id }}"
                      data-lat1="{{ viaje.lat_origen|floatformat:6 }}"
                      data-lon1="{{ viaje.lon_origen|floatformat:6 }}"
                      data-lat2="{{ viaje.lat_destino|floatformat:6 }}"
                      data-lon2="{{ viaje.lon_destino|floatformat:6 }}">
                      Simular
                  </button>
              </td>
          </tr>
          {% empty %}
          <tr><td colspan="4" class="text-center text-muted py-3">No hay viajes</td></tr>
          {% endfor %}

        </tbody>
      </table>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-success text-white">Mapa del recorrido</div>
    <div class="card-body p-0">
      <div id="map" style="height: 550px; border-radius: 10px;"></div>
    </div>
  </div>
</div>

<script>
/* =======================================================
   Inicializar mapa
======================================================= */
document.addEventListener("DOMContentLoaded", () => {

    console.log("Mapa cargando...");

    window.map = L.map('map').setView([-24.1858, -65.2995], 10);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    window.polyline = null;
    window.marker = null;
    window.animInterval = null;

    document.querySelectorAll(".btn-simular").forEach(btn => {
        btn.addEventListener("click", () => {

            const viaje_id = btn.dataset.id;

            // üî• FIX IMPORTANTE: reemplazar comas
            const lat1 = parseFloat(btn.dataset.lat1.replace(",", "."));
            const lon1 = parseFloat(btn.dataset.lon1.replace(",", "."));
            const lat2 = parseFloat(btn.dataset.lat2.replace(",", "."));
            const lon2 = parseFloat(btn.dataset.lon2.replace(",", "."));

            iniciarSimulacion(viaje_id, lat1, lon1, lat2, lon2);
        });
    });
});

/* =======================================================
   Convertir ruta a Leaflet
======================================================= */
function fixRuta(arr) {
    return arr.map(p => L.latLng(p[0], p[1]));
}

/* =======================================================
   Obtener ruta desde el backend
======================================================= */
async function obtenerRuta(start, end) {
    try {
        const response = await fetch(`/api/ruta/?start=${start}&end=${end}`);
        return await response.json();
    } catch (err) {
        console.error(err);
        return null;
    }
}

/* =======================================================
   Guardar posici√≥n
======================================================= */
async function guardarPosicion(viaje_id, lat, lon, velocidad) {

    await fetch("/api/guardar_posicion/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            viaje_id: viaje_id,
            latitud: lat,
            longitud: lon,
            velocidad: velocidad
        })
    });
}

/* =======================================================
   Finalizar viaje
======================================================= */
async function finalizarViaje(viaje_id) {

    const resp = await fetch("/api/finalizar_viaje/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ viaje_id })
    });

    const data = await resp.json();

    if (data.ok) {
        const fila = document.getElementById(`fila-${viaje_id}`);
        if (fila) fila.remove();
    }
}

/* =======================================================
   Simulaci√≥n principal
======================================================= */
async function iniciarSimulacion(viaje_id, lat1, lon1, lat2, lon2) {

    if (animInterval) clearInterval(animInterval);
    if (polyline) map.removeLayer(polyline);
    if (marker) map.removeLayer(marker);

    const ruta = await obtenerRuta(`${lat1},${lon1}`, `${lat2},${lon2}`);

    if (!ruta || !Array.isArray(ruta) || ruta.length < 2) {
        alert("No se pudo obtener la ruta.");
        return;
    }

    const rutaFix = fixRuta(ruta);

    polyline = L.polyline(rutaFix, { color: 'blue' }).addTo(map);
    map.fitBounds(polyline.getBounds());

    marker = L.marker(rutaFix[0]).addTo(map);
    map.panTo(rutaFix[0]);

    let index = 0;
    const delay = 800;

    animInterval = setInterval(async () => {

        if (index >= rutaFix.length) {
            clearInterval(animInterval);

            await finalizarViaje(viaje_id);

            alert("Viaje finalizado.");
            return;
        }

        const actual = rutaFix[index];
        const anterior = rutaFix[index - 1] || actual;

        // velocidad aproximada
        const distancia = map.distance(anterior, actual);
         // velocidad realista reducida a la mitad
        const velocidad = ((distancia / (delay / 1000)) * 3.6) / 3;

        marker.setLatLng(actual);
        map.panTo(actual);

        await guardarPosicion(viaje_id, actual.lat, actual.lng, velocidad);

        index++;

    }, delay);
}

</script>

{% endblock %}
