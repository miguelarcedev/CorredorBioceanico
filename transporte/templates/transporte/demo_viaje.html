
{% extends 'transporte/base.html' %}

{% block content %}
{% load static %}
<div class="container-fluid mt-4">

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Viajes en curso</h5>
    </div>
    <div class="card-body p-0">
      <table class="table table-striped table-hover mb-0 text-center align-middle">
        <thead class="table-light">
          <tr>
            <th>Origen</th>
            <th>Destino</th>
            <th>Estado</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="tabla-viajes">

          {% for viaje in viajes %}
          <tr>
              <td>{{ viaje.origen }}</td>
              <td>{{ viaje.destino }}</td>
              <td><span class="badge bg-info text-dark">{{ viaje.estado }}</span></td>
              <td>
                  <button class="btn btn-primary btn-sm btn-simular"
                      data-lat1="{{ viaje.lat_origen|floatformat:6 }}"
                      data-lon1="{{ viaje.lon_origen|floatformat:6 }}"
                      data-lat2="{{ viaje.lat_destino|floatformat:6 }}"
                      data-lon2="{{ viaje.lon_destino|floatformat:6 }}">
                      Simular
                  </button>
              </td>
          </tr>
          {% empty %}
          <tr><td colspan="4" class="text-center text-muted py-3">No hay viajes</td></tr>
          {% endfor %}

        </tbody>
      </table>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-success text-white">Mapa del recorrido</div>
    <div class="card-body p-0">
      <div id="map" style="height: 550px; border-radius: 10px;"></div>
    </div>
  </div>
</div>

<script>
// ======================================
//     Crear el mapa
// ======================================
document.addEventListener("DOMContentLoaded", () => {

    console.log("DOM cargado — creando mapa");

    window.map = L.map('map').setView([-24.1858, -65.2995], 10);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    window.polyline = null;
    window.marker = null;
    window.animInterval = null;

    document.querySelectorAll(".btn-simular").forEach(btn => {
        btn.addEventListener("click", () => {

            const lat1 = parseFloat(btn.dataset.lat1.replace(",", "."));
            const lon1 = parseFloat(btn.dataset.lon1.replace(",", "."));
            const lat2 = parseFloat(btn.dataset.lat2.replace(",", "."));
            const lon2 = parseFloat(btn.dataset.lon2.replace(",", "."));

            iniciarSimulacion(lat1, lon1, lat2, lon2);
        });
    });
});

// ======================================
//    Convertir array [lat,lon] a Leaflet
// ======================================
function fixRuta(arr) {
    return arr.map(p => L.latLng(p[0], p[1]));
}

// ======================================
//         Obtener ruta real
// ======================================
async function obtenerRuta(start, end) {

    console.log(">>> Llamando a API ruta:");
    console.log("Start:", start);
    console.log("End:", end);

    try {
        const response = await fetch(`/api/ruta/?start=${start}&end=${end}`);
        const data = await response.json();

        return data;

    } catch (err) {
        console.error("ERROR obteniendo ruta:", err);
        return null;
    }
}

// ======================================
//        Simulación del recorrido
// ======================================
async function iniciarSimulacion(lat1, lon1, lat2, lon2) {

    console.log("=== DEBUG COORDENADAS ===");
    console.log("Inicio:", lat1, lon1);
    console.log("Destino:", lat2, lon2);

    if (isNaN(lat1) || isNaN(lon1) || isNaN(lat2) || isNaN(lon2)) {
        alert("Coordenadas inválidas.");
        return;
    }

    if (animInterval) clearInterval(animInterval);
    if (polyline) map.removeLayer(polyline);
    if (marker) map.removeLayer(marker);

    const ruta = await obtenerRuta(`${lat1},${lon1}`, `${lat2},${lon2}`);

    console.log("=== DEBUG RUTA OBTENIDA ===");
    console.log(ruta);

    if (!ruta || !Array.isArray(ruta) || ruta.length < 2) {
        alert("Error obteniendo ruta.");
        return;
    }

    const rutaFix = fixRuta(ruta);

    console.log("=== DEBUG RUTA TRANSFORMADA PARA LEAFLET ===");
    console.log(rutaFix);

    polyline = L.polyline(rutaFix, { color: 'blue' }).addTo(map);
    map.fitBounds(polyline.getBounds());

    // ============================
    //     ICONO DE CAMIÓN
    // ============================
    const truckIcon = L.icon({
        iconUrl: "{% static 'img/truck.png' %}",
        iconSize: [32, 32],
        iconAnchor: [16, 16]
    });

    marker = L.marker(rutaFix[0], { icon: truckIcon }).addTo(map);

    // Función para rotar icono según dirección
    function getAngle(p1, p2) {
        const dy = p2.lat - p1.lat;
        const dx = p2.lng - p1.lng;
        return (Math.atan2(dy, dx) * 180 / Math.PI) + 90;
    }

    map.panTo(rutaFix[0]);

    let index = 0;
    const delay = 250;

    animInterval = setInterval(() => {
        if (index >= rutaFix.length) {
            clearInterval(animInterval);
            return;
        }

        const prev = rutaFix[index > 0 ? index - 1 : 0];
        const next = rutaFix[index];

        marker.setLatLng(next);

        // Rotación del icono
        const angle = getAngle(prev, next);
        marker._icon.style.transform = `rotate(${angle}deg)`;

        map.panTo(next);
        index++;

    }, delay);
}
</script>

{% endblock %}
