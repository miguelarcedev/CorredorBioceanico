<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Monitoreo Demo</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        #map {
            height: 550px;
            width: 100%;
            border-radius: 12px;
        }

        .btn {
            padding: 8px 15px;
            margin-right: 10px;
            cursor: pointer;
        }

        .info-box {
            font-size: 16px;
            padding: 10px;
            background: #f1f1f1;
            border-radius: 8px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

<h2>Simulación de Viaje</h2>

{% if viajes %}
    {% for v in viajes %}
        <div class="info-box">
            <b>Viaje:</b> {{ v.id }}<br>
            <b>Origen:</b> {{ v.lat_origen }} , {{ v.lon_origen }}<br>
            <b>Destino:</b> {{ v.lat_destino }} , {{ v.lon_destino }}
        </div>

        <button class="btn" onclick="iniciarSimulacion({{ v.lat_origen }}, {{ v.lon_origen }}, {{ v.lat_destino }}, {{ v.lon_destino }})">
            ▶ Iniciar Simulación
        </button>

        <button class="btn" onclick="detenerSimulacion()">⏹ Detener</button>
    {% endfor %}
{% else %}
    <p>No hay viajes en curso.</p>
{% endif %}

<div id="map"></div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map;
let polyline = null;
let marker = null;
let interval = null;

document.addEventListener("DOMContentLoaded", function() {

    console.log(">> DOM Cargado — creando mapa.");

    map = L.map('map').setView([-24.185, -65.297], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    // Fix obligatorio para Leaflet
    setTimeout(() => map.invalidateSize(), 300);
});


// ================================
// Obtener ruta desde la API Django
// ================================
async function obtenerRuta(start, end) {
    console.log(">>> Llamando a API ruta:");
    console.log("Start:", start);
    console.log("End:", end);

    const resp = await fetch(`/api/ruta/?start=${start}&end=${end}`);
    const data = await resp.json();

    console.log("=== DEBUG RUTA OBTENIDA ===");
    console.log(data);

    return data;
}

// Convierto array a latlng válido
function fixRuta(arr) {
    return arr.map(point => L.latLng(point[0], point[1]));
}


// ================================
// Simulación
// ================================
async function iniciarSimulacion(lat1, lon1, lat2, lon2) {

    detenerSimulacion();

    console.log("=== DEBUG COORDENADAS ===");
    console.log("Inicio:", lat1, lon1);
    console.log("Destino:", lat2, lon2);

    setTimeout(() => map.invalidateSize(), 200);

    const ruta = await obtenerRuta(`${lat1},${lon1}`, `${lat2},${lon2}`);
    const rutaFix = fixRuta(ruta);

    console.log("=== DEBUG RUTA TRANSFORMADA ===");
    console.log(rutaFix);

    // Limpieza previa
    if (polyline) map.removeLayer(polyline);
    if (marker) map.removeLayer(marker);

    // Dibuja polyline
    polyline = L.polyline(rutaFix, { color: 'blue', weight: 5 }).addTo(map);

    // Fix importante
    setTimeout(() => {
        map.invalidateSize(true);
        map.fitBounds(polyline.getBounds());
    }, 300);

    // Marker
    marker = L.marker(rutaFix[0]).addTo(map);

    let index = 0;

    interval = setInterval(() => {
        if (index >= rutaFix.length) {
            clearInterval(interval);
            return;
        }
        marker.setLatLng(rutaFix[index]);
        index++;
    }, 500);
}

function detenerSimulacion() {
    if (interval) clearInterval(interval);
    interval = null;

    if (marker) map.removeLayer(marker);
    if (polyline) map.removeLayer(polyline);
}

</script>

</body>
</html>
