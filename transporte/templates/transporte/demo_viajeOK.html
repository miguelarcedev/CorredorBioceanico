{% extends 'transporte/base.html' %}
{% block content %}
<div class="container-fluid mt-4">
  <h2>Simulación de viajes - Modo Demo</h2>

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Viajes disponibles para simular</h5>
    </div>
    <div class="card-body p-0">
      <table class="table table-striped table-hover mb-0 text-center align-middle">
        <thead class="table-light">
          <tr>
            <th>Origen</th>
            <th>Destino</th>
            <th>Estado</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="tabla-viajes">
          {% for viaje in viajes %}
<tr>
    <td>{{ viaje.origen }}</td>
    <td>{{ viaje.destino }}</td>
    <td><span class="badge bg-info text-dark">{{ viaje.estado }}</span></td>
    <td>
        <button class="btn btn-primary btn-sm btn-simular"
                data-lat1="{{ viaje.lat_origen }}"
                data-lon1="{{ viaje.lon_origen }}"
                data-lat2="{{ viaje.lat_destino }}"
                data-lon2="{{ viaje.lon_destino }}">
            Simular
        </button>
    </td>
</tr>
{% empty %}
<tr><td colspan="4" class="text-center text-muted py-3">No hay viajes</td></tr>
{% endfor %}

        </tbody>
      </table>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-success text-white">Mapa del recorrido</div>
    <div class="card-body p-0">
      <div id="map" style="height: 550px; border-radius: 10px;"></div>
    </div>
  </div>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
const API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImFlNmEzYWMxNTQ3MDRkYTE5ZGIwMzhiNzU4OGU4ZTY2IiwiaCI6Im11cm11cjY0In0=";

let map = L.map('map').setView([-24.1858, -65.2995], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

let polyline = null;
let marker = null;
let animInterval = null;

// ============================
//   OBTENER RUTA REAL
// ============================
async function obtenerRuta(start, end) {
  try {
    const response = await fetch(`/api/ruta/?start=${start}&end=${end}`);
    const data = await response.json();
    if (data.error) {
      console.error("Error obteniendo ruta:", data.error);
      return null;
    }
    return data;
  } catch (err) {
    console.error("Error de conexión al obtener ruta:", err);
    return null;
  }
}

// ============================
//   ANIMAR VEHÍCULO
// ============================
function moverMarcadorSuave(marker, start, end, duracion = 3000) {
  const steps = 30;
  let i = 0;
  const interval = setInterval(() => {
    const lat = start[0] + (end[0] - start[0]) * (i / steps);
    const lon = start[1] + (end[1] - start[1]) * (i / steps);
    marker.setLatLng([lat, lon]);
    if (i++ >= steps) clearInterval(interval);
  }, duracion / steps);
}

// ============================
//   SIMULAR VIAJE
// ============================
async function iniciarSimulacion(lat1, lon1, lat2, lon2) {
  if (animInterval) clearInterval(animInterval);
  if (polyline) map.removeLayer(polyline);
  if (marker) map.removeLayer(marker);

  const ruta = await obtenerRuta(`${lat1},${lon1}`, `${lat2},${lon2}`);
  if (!ruta) {
    alert("No se pudo obtener la ruta real. Verifique su conexión o API Key.");
    return;
  }

  polyline = L.polyline(ruta, { color: 'blue' }).addTo(map);
  map.fitBounds(polyline.getBounds());
  marker = L.marker(ruta[0]).addTo(map);

  let index = 0;
  animInterval = setInterval(() => {
    if (index < ruta.length - 1) {
      moverMarcadorSuave(marker, ruta[index], ruta[index + 1]);
      index++;
    } else {
      clearInterval(animInterval);
    }
  }, 3000);
}

// ============================
//   CARGAR VIAJES DEMO
// ============================
async function cargarViajesDemo() {
  try {
    const res = await fetch("/api/viajes_demo/");
    const viajes = await res.json();

    const tabla = document.getElementById("tabla-viajes");
    tabla.innerHTML = "";

    if (!viajes.length) {
      tabla.innerHTML = `<tr><td colspan="4" class="text-muted py-3">No hay viajes disponibles</td></tr>`;
      return;
    }

    viajes.forEach(viaje => {
      const p_ini = viaje.posiciones[0];
      const p_fin = viaje.posiciones[viaje.posiciones.length - 1];

      const fila = document.createElement("tr");
      fila.innerHTML = `
        <td>${viaje.origen}</td>
        <td>${viaje.destino}</td>
        <td><span class="badge bg-info text-dark">${viaje.estado}</span></td>
        <td><button class="btn btn-primary btn-sm">Simular</button></td>
      `;

      fila.querySelector("button").addEventListener("click", () => {
        iniciarSimulacion(p_ini.latitud, p_ini.longitud, p_fin.latitud, p_fin.longitud);
      });

      tabla.appendChild(fila);
    });
  } catch (err) {
    console.error("Error cargando viajes demo:", err);
    document.getElementById("tabla-viajes").innerHTML = `
      <tr><td colspan="4" class="text-danger py-3">Error al cargar viajes demo</td></tr>`;
  }
}

// ============================
//   INICIO
// ============================
document.addEventListener("DOMContentLoaded", cargarViajesDemo);
</script>
{% endblock %}
