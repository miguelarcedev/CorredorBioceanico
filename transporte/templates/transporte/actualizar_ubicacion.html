{% extends 'transporte/base.html' %}
{% block content %}
<h4>Actualizar ubicación en tiempo real</h4>
<p class="text-muted">Presioná el botón para obtener tu ubicación GPS y actualizarla en el sistema.</p>

<div id="map" style="height: 400px; border-radius: 10px;"></div>

<form method="post" id="ubicacionForm" class="mt-3">
    {% csrf_token %}
    <input type="hidden" name="lat" id="lat">
    <input type="hidden" name="lon" id="lon">
    <button type="submit" class="btn btn-success w-100 mt-3">Guardar ubicación</button>
</form>

<script>
    let map, marker;

    // Inicializamos el mapa centrado en Jujuy
    map = L.map('map').setView([-24.1858, -65.2995], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    function onLocationFound(e) {
        const lat = e.latitude;
        const lon = e.longitude;

        // Mostramos marcador en el mapa
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lon]).addTo(map);
        map.setView([lat, lon], 14);

        // Guardamos las coordenadas en el formulario oculto
        document.getElementById('lat').value = lat;
        document.getElementById('lon').value = lon;
    }

    function onLocationError(e) {
        alert("No se pudo obtener la ubicación. Asegurate de habilitar el GPS o permisos de ubicación.");
    }

    // Intentamos obtener la ubicación actual
    map.locate({ setView: true, maxZoom: 16 });
    map.on('locationfound', onLocationFound);
    map.on('locationerror', onLocationError);
</script>

<a href="{% url 'viaje_detalle' viaje.id %}" class="btn btn-secondary mt-3">Volver</a>
{% endblock %}
