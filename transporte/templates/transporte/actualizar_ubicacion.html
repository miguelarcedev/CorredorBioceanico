{% extends 'transporte/base.html' %}
{% block content %}
<h4>Seguimiento en tiempo real del vehículo</h4>
<p class="text-muted">
El sistema actualiza automáticamente tu ubicación cada 30 segundos y la envía al servidor.
</p>

<div id="map" style="height: 400px; border-radius: 10px;"></div>

<div class="alert alert-info mt-3" id="status">
Esperando datos de GPS...
</div>

<a href="{% url 'viaje_detalle' viaje.id %}" class="btn btn-secondary mt-3">Volver</a>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let map = L.map('map').setView([-24.1858, -65.2995], 13);
    let marker;
    let statusBox = document.getElementById("status");

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    function actualizarUbicacion() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    if (marker) {
                        marker.setLatLng([lat, lon]);
                    } else {
                        marker = L.marker([lat, lon]).addTo(map)
                            .bindPopup("Ubicación actual del vehículo")
                            .openPopup();
                    }

                    map.setView([lat, lon], 14);

                    // Enviar coordenadas al servidor Django
                    fetch("{% url 'actualizar_ubicacion_api' viaje.id %}", {
                        method: "POST",
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `lat=${lat}&lon=${lon}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        statusBox.innerText = "Última actualización: " + new Date().toLocaleTimeString();
                    })
                    .catch(err => {
                        statusBox.innerText = "Error al enviar ubicación: " + err;
                    });
                },
                function(error) {
                    statusBox.innerText = "No se pudo obtener ubicación: " + error.message;
                }
            );
        } else {
            statusBox.innerText = "Tu navegador no soporta geolocalización.";
        }
    }

    // Ejecutar inmediatamente y luego cada 30 segundos
    actualizarUbicacion();
    setInterval(actualizarUbicacion, 30000);

    // Permitir ajuste manual
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;

        if (marker) {
            marker.setLatLng([lat, lon]);
        } else {
            marker = L.marker([lat, lon]).addTo(map);
        }

        fetch("{% url 'actualizar_ubicacion_api' viaje.id %}", {
            method: "POST",
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `lat=${lat}&lon=${lon}`
        })
        .then(response => response.json())
        .then(data => {
            statusBox.innerText = "Ubicación ajustada manualmente: " + new Date().toLocaleTimeString();
        });
    });
});
</script>
{% endblock %}
