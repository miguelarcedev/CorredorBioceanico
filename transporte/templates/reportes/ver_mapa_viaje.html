{% extends "transporte/base.html" %}
{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* ---- ESTILO PROFESIONAL ---- */

    .section-title {
        font-size: 1.7rem;
        font-weight: 700;
        color: #0d47a1;
        margin-bottom: 20px;
    }

    .export-btn {
        float: right;
        margin-top: -45px;
    }

    .info-label {
        font-size: 0.85rem;
        font-weight: 700;
        color: #0d47a1;
        text-transform: uppercase;
        letter-spacing: .5px;
    }

    .info-box {
        background: #f7faff;
        border-radius: 12px;
        padding: 18px;
        margin-bottom: 16px;
        box-shadow: 0 3px 7px rgba(0,0,0,0.08);
        border-left: 4px solid #1976d2;
    }

    .summary-box {
        background: #ffffff;
        border-radius: 12px;
        padding: 22px;
        box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        border-top: 4px solid #0d47a1;
    }

    .summary-item {
        text-align: center;
        padding: 15px 10px;
    }

    .summary-item strong {
        font-size: 1.1rem;
        color: #003c8f;
    }

    .summary-value {
        font-size: 1.4rem;
        font-weight: 700;
        color: #0d47a1;
    }

    #map {
        border-radius: 12px;
        overflow: hidden;
    }

</style>

<div class="container mt-4 mb-5">

    <!-- T√çTULO + BOT√ìN PDF -->
    <h3 class="section-title">
        üìç Recorrido del viaje ‚Äî {{ viaje.origen }} ‚Üí {{ viaje.destino }}
    </h3>

    <a href="{% url 'exportar_pdf_viaje' viaje.id %}" class="btn btn-danger shadow-sm export-btn">
        <i class="bi bi-file-earmark-pdf-fill"></i> Exportar PDF
    </a>

    <div class="clearfix"></div>


    <!-- DATOS DEL VIAJE -->
    <div class="info-box">

        <h5 class="mb-3">
            <i class="bi bi-info-circle-fill text-primary"></i> Datos Generales del Viaje
        </h5>

        <div class="row">

            <div class="col-md-6 mb-3">
                <div class="info-label">Chofer</div>
                <div>{{ viaje.chofer.nombre }} {{ viaje.chofer.apellido }}</div>
                <small class="text-muted">DNI: {{ viaje.chofer.documento }} ‚Äî Licencia: {{ viaje.chofer.licencia_nro }}</small>
            </div>

            <div class="col-md-6 mb-3">
                <div class="info-label">Veh√≠culo</div>
                <div>{{ viaje.vehiculo.patente }} ‚Äî {{ viaje.vehiculo.marca }} {{ viaje.vehiculo.modelo }}</div>
                <small class="text-muted">Capacidad: {{ viaje.vehiculo.capacidad }} tn</small>
            </div>

            <div class="col-md-6 mb-3">
                <div class="info-label">Carga transportada</div>
                <div>{{ viaje.carga.tipo }} ‚Äî {{ viaje.carga.peso_aprox }} tn</div>
                <small class="text-muted">{{ viaje.carga.descripcion }}</small>
            </div>

            <div class="col-md-6 mb-3">
                <div class="info-label">Estado actual</div>
                <span class="badge bg-info text-dark px-3 py-2">
                    {{ viaje.get_estado_display }}
                </span>
            </div>

            <div class="col-md-4">
                <div class="info-label">Fecha salida</div>
                {{ viaje.fecha_salida|date:"d/m/Y H:i" }}
            </div>

            <div class="col-md-4">
                <div class="info-label">Fecha estimada de llegada</div>
                {{ viaje.fecha_llegada_estimada|date:"d/m/Y H:i" }}
            </div>

            <div class="col-md-4">
                <div class="info-label">Fecha real de llegada</div>
                {% if viaje.fecha_llegada_real %}
                    {{ viaje.fecha_llegada_real|date:"d/m/Y H:i" }}
                {% else %}
                    <span class="text-muted">A√∫n no finalizado</span>
                {% endif %}
            </div>

        </div>
    </div>


    <!-- RESUMEN DEL VIAJE -->
    <div class="summary-box">

        <h5 class="mb-3">
            <i class="bi bi-bar-chart-fill text-primary"></i> Resumen del Viaje
        </h5>

        <div class="row text-center">

            <div class="col-md-3 summary-item">
                <strong>Distancia real</strong>
                <div class="summary-value">{{ resumen.distancia_total }} km</div>
            </div>

            <div class="col-md-3 summary-item">
                <strong>Vel. promedio</strong>
                <div class="summary-value">{{ resumen.velocidad_promedio }} km/h</div>
            </div>

            <div class="col-md-3 summary-item">
                <strong>Vel. m√°xima</strong>
                <div class="summary-value">{{ resumen.velocidad_max }} km/h</div>
            </div>

            <div class="col-md-3 summary-item">
                <strong>Vel. m√≠nima</strong>
                <div class="summary-value">{{ resumen.velocidad_min }} km/h</div>
            </div>

        </div>

    </div>


    <!-- MAPA -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">
            üó∫Ô∏è Recorrido del veh√≠culo
        </div>
        <div class="card-body p-0">
            <div id="map" style="height: 550px;"></div>
        </div>
    </div>


    <!-- GR√ÅFICO -->
    <div class="card shadow-sm mb-5">
        <div class="card-header bg-dark text-white">üìà Velocidad vs Tiempo</div>
        <div class="card-body">
            <canvas id="velChart" height="120"></canvas>
        </div>
    </div>

    <!-- TABLA -->
    <div class="card shadow-sm mb-5">
        <div class="card-header bg-secondary text-white">üìã Detalle de posiciones</div>
        <div class="card-body p-0">
            <table class="table table-striped table-hover text-center mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Tiempo</th>
                        <th>Latitud</th>
                        <th>Longitud</th>
                        <th>Velocidad (km/h)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in puntos %}
                    <tr>
                        <td>{{ p.t }}</td>
                        <td>{{ p.lat }}</td>
                        <td>{{ p.lon }}</td>
                        <td class="{% if p.vel > 80 %}text-danger fw-bold{% endif %}">
                            {{ p.vel|floatformat:1 }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>
{% endblock %}