{% extends 'transporte/base.html' %}
{% block content %}

<div class="container mt-4">
    <h2 class="text-primary mb-3">
        üó∫Ô∏è Recorrido del Viaje ‚Äî {{ viaje.origen }} ‚Üí {{ viaje.destino }}
    </h2>

    <p>
        <strong>Chofer:</strong> {{ viaje.chofer }} <br>
        <strong>Veh√≠culo:</strong> {{ viaje.vehiculo }} <br>
        <strong>Fecha:</strong> {{ viaje.fecha_salida|date:"d/m/Y H:i" }} ‚Üí 
        {{ viaje.fecha_llegada_real|date:"d/m/Y H:i" }} <br>
        <strong>Kil√≥metros recorridos:</strong> {{ viaje.kilometros_recorridos|floatformat:2 }} km
    </p>

    <div id="map" style="height: 600px;" class="mb-4 shadow rounded"></div>
</div>

<script>
    const puntos = {{ puntos|safe }};

    const map = L.map('map').setView([puntos[0].lat, puntos[0].lon], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    // L√≠nea completa del viaje
    const polyline = L.polyline(
        puntos.map(p => [p.lat, p.lon]),
        { color: "blue", weight: 4 }
    ).addTo(map);

    map.fitBounds(polyline.getBounds());

    // Marcador inicio
    L.marker([puntos[0].lat, puntos[0].lon])
        .addTo(map)
        .bindPopup("<b>Inicio</b>");

    // Marcador fin
    const ultimo = puntos[puntos.length - 1];
    L.marker([ultimo.lat, ultimo.lon], { icon: L.icon({ 
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/190/190411.png',
            iconSize: [32, 32]
    }) })
        .addTo(map)
        .bindPopup("<b>Fin del viaje</b>");

    // Opcional: puntos con velocidad
    puntos.forEach(p => {
        L.circleMarker([p.lat, p.lon], {
            radius: 4,
            color: p.velocidad > 80 ? 'red' : 'green'
        }).addTo(map)
          .bindPopup("Vel: " + p.velocidad + " km/h<br>" + p.tiempo);
    });
</script>

{% endblock %}
