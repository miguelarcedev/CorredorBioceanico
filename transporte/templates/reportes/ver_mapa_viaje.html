{% extends "transporte/base.html" %}
{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container mt-4">

    <h3 class="text-primary mb-3">
        ğŸ“ Recorrido del viaje â€” {{ viaje.origen }} â†’ {{ viaje.destino }}
    </h3>

    <!-- Resumen del viaje -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">Resumen del viaje</div>
        <div class="card-body">

            <div class="row">

                <div class="col-md-3"><strong>Distancia real:</strong><br>{{ resumen.distancia_total }} km</div>
                <div class="col-md-3"><strong>Vel. promedio:</strong><br>{{ resumen.velocidad_promedio }} km/h</div>
                <div class="col-md-3"><strong>Vel. mÃ¡xima:</strong><br>{{ resumen.velocidad_max }} km/h</div>
                <div class="col-md-3"><strong>Vel. mÃ­nima:</strong><br>{{ resumen.velocidad_min }} km/h</div>

            </div>

        </div>
    </div>

    <!-- Mapa -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">ğŸ—ºï¸ Recorrido del vehÃ­culo</div>
        <div class="card-body p-0">
            <div id="map" style="height: 550px;"></div>
        </div>
    </div>

    <!-- GrÃ¡fico -->
    <div class="card shadow-sm mb-5">
        <div class="card-header bg-dark text-white">ğŸ“ˆ Velocidad vs Tiempo</div>
        <div class="card-body">
            <canvas id="velChart" height="120"></canvas>
        </div>
    </div>

</div>

<script>

const puntos = {{ puntos|safe }};

document.addEventListener("DOMContentLoaded", function () {

    if (!puntos || puntos.length === 0) {
        alert("No hay puntos registrados.");
        return;
    }

    /* ============================
           MAPA
    ============================= */
    const map = L.map("map").setView([puntos[0].lat, puntos[0].lon], 14);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
    }).addTo(map);

    const ruta = puntos.map(p => [p.lat, p.lon]);

    const polyline = L.polyline(ruta, { color: "blue" }).addTo(map);

    map.fitBounds(polyline.getBounds());

    L.marker(ruta[0]).addTo(map).bindPopup("Inicio");
    L.marker(ruta[ruta.length - 1]).addTo(map).bindPopup("Fin");

    /* ============================
           GRAFICO VELOCIDAD
    ============================= */
    const labels = puntos.map(p => p.t);
    const velocidades = puntos.map(p => p.vel);

    new Chart(document.getElementById("velChart"), {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Velocidad (km/h)",
                data: velocidades,
                borderWidth: 2,
                fill: false
            }]
        }
    });

});

</script>

{% endblock %}
