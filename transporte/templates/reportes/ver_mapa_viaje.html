{% extends "transporte/base.html" %}
{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

<div class="container mt-4">

    <h3 class="text-primary mb-3">
        ğŸšš Recorrido del viaje â€” {{ viaje.origen }} â†’ {{ viaje.destino }}
    </h3>

    <!-- Datos del viaje -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <p><strong>Chofer:</strong> {{ viaje.chofer }}</p>
            <p><strong>VehÃ­culo:</strong> {{ viaje.vehiculo }}</p>
            <p><strong>Empresa:</strong> {{ viaje.empresa }}</p>
            <p><strong>Salida:</strong> {{ viaje.fecha_salida }}</p>
            <p><strong>Llegada real:</strong> {{ viaje.fecha_llegada_real }}</p>
        </div>
    </div>

    <!-- Mapa -->
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white">ğŸ—ºï¸ Recorrido histÃ³rico</div>
        <div class="card-body p-0">
            <div id="map" style="height: 550px;"></div>
        </div>
    </div>

</div>

<script>
// Datos enviados desde Django âœ lista de puntos
const puntos = {{ puntos|safe }};

document.addEventListener("DOMContentLoaded", function () {

    if (!puntos || puntos.length === 0) {
        alert("No hay posiciones registradas para este viaje.");
        return;
    }

    // Inicializar mapa centrado en el primer punto
    const map = L.map("map").setView([puntos[0].lat, puntos[0].lon], 14);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
    }).addTo(map);

    // Convertir puntos a lÃ­nea para Leaflet
    const ruta = puntos.map(p => [p.lat, p.lon]);

    // Dibujar lÃ­nea
    const polyline = L.polyline(ruta, { color: "blue" }).addTo(map);

    // Ajustar zoom al recorrido
    map.fitBounds(polyline.getBounds());

    // Marcar inicio y final
    L.marker(ruta[0]).addTo(map).bindPopup("Inicio");
    L.marker(ruta[ruta.length - 1]).addTo(map).bindPopup("Fin");

});
</script>

{% endblock %}
